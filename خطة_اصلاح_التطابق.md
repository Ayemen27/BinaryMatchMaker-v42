# خطة اصلاح التطابق بين حقول واجهة المستخدم وأعمدة قاعدة البيانات

## مقدمة
هذه الوثيقة تحدد خطة شاملة لضمان التطابق التام بين أسماء الحقول المستخدمة في واجهة المستخدم وأسماء الأعمدة المقابلة في قاعدة البيانات. الهدف الرئيسي هو تحقيق اتساق كامل في جميع أجزاء التطبيق وتجنب الحاجة إلى تحويل الأسماء بين واجهة المستخدم والخادم.

## المشكلة الحالية
- عدم تطابق بين أسماء الحقول في واجهة المستخدم والأعمدة في قاعدة البيانات
- استخدام أسماء مختلفة للإشارة إلى نفس البيانات في أجزاء مختلفة من التطبيق
- وجود شيفرة إضافية للتحويل بين الأنماط المختلفة للتسمية

## المرحلة الأولى: تحديد النماذج والحقول

### 1. النماذج والحقول المتأثرة:

- **إعدادات المستخدم (UserSettings)**:
  - قاعدة البيانات: `theme`, `default_asset`, `default_timeframe`, إلخ...
  - واجهة المستخدم: تأكد من استخدام الأسماء المطابقة `theme`, `defaultAsset`, `defaultTimeframe`

- **إعدادات الإشعارات (NotificationSettings)**:
  - قاعدة البيانات: `email_notifications`, `push_notifications`, `signal_alerts`, `market_updates`, `account_alerts`, `promotional_emails`
  - واجهة المستخدم: تعديل `email`, `push`, `signalGeneration`, إلخ... لتتطابق مع الأسماء في قاعدة البيانات

- **نموذج المستخدم (User)**:
  - التأكد من تطابق حقول المستخدم بين الواجهة وقاعدة البيانات

- **نموذج الإشارات (Signals)**:
  - التأكد من تطابق الحقول المتعلقة بالإشارات بين الواجهة وقاعدة البيانات

## المرحلة الثانية: تعديل نماذج البيانات في الواجهة

### 1. تحديث مخططات البيانات في ملفات الواجهة:

- تعديل جميع نماذج البيانات (interfaces أو types) لاستخدام نفس أسماء الحقول كما في قاعدة البيانات
- التأكد من استخدام مخطط التسمية المناسب (camelCase للواجهة، snake_case لقاعدة البيانات) مع استخدام أداة التحويل إذا لزم الأمر

### 2. تحديث ملفات النماذج:

```typescript
// مثال على التعديل في إعدادات الإشعارات
// من
interface NotificationSettings {
  email: boolean;
  push: boolean;
  signalGeneration: boolean;
  signalResults: boolean;
  marketAlerts: boolean;
  accountAlerts: boolean;
}

// إلى
interface NotificationSettings {
  emailNotifications: boolean;
  pushNotifications: boolean;
  signalAlerts: boolean;
  marketUpdates: boolean;
  accountAlerts: boolean;
  promotionalEmails: boolean;
}
```

## المرحلة الثالثة: تعديل مكونات واجهة المستخدم

### 1. تحديث مكونات النماذج:

- **الملفات المتأثرة**:
  - `client/src/pages/settings-page.tsx`
  - `client/src/components/settings/notification-settings.tsx`
  - وغيرها من المكونات التي تتعامل مع نماذج الإعدادات

- **التغييرات المطلوبة**:
  - تحديث جميع الإشارات إلى حقول النماذج
  - تعديل مكونات React-Hook-Form لتستخدم الأسماء الجديدة
  - تحديث نماذج Zod للتحقق من صحة البيانات

### 2. تحديث معالجات الأحداث:

```jsx
// مثال على التعديل المطلوب
// من
<Switch 
  id="email-notifications" 
  checked={notificationSettings.email}
  onCheckedChange={(checked) => handleNotificationChange('email', checked)}
/>

// إلى
<Switch 
  id="email-notifications" 
  checked={notificationSettings.emailNotifications}
  onCheckedChange={(checked) => handleNotificationChange('emailNotifications', checked)}
/>
```

## المرحلة الرابعة: تعديل طلبات API والمعالجات في الخادم

### 1. تعديل طلبات API:

- **الملفات المتأثرة**:
  - `client/src/lib/api.ts`
  - أي ملفات أخرى تقوم بإرسال طلبات API

- **التغييرات المطلوبة**:
  - تحديث أسماء الحقول في جميع طلبات API
  - التأكد من تطابق أسماء الحقول المرسلة مع أسماء الأعمدة في قاعدة البيانات

### 2. تعديل معالجات الطلبات في الخادم:

- **الملفات المتأثرة**:
  - `server/routes.ts`
  - `server/routes/user-settings.ts`
  - وغيرها من ملفات الخادم التي تتعامل مع الطلبات

- **التغييرات المطلوبة**:
  - تبسيط معالجة طلبات API
  - إزالة أي شيفرة زائدة للتحويل بين أنماط التسمية

```javascript
// مثال على التعديل المطلوب
// من
const notificationSettings = {
  emailNotifications: typeof req.body.emailNotifications !== 'undefined' ? req.body.emailNotifications : 
                   typeof req.body.allowEmailNotifications !== 'undefined' ? req.body.allowEmailNotifications : undefined,
  // ...
};

// إلى
const notificationSettings = {
  emailNotifications: req.body.emailNotifications,
  pushNotifications: req.body.pushNotifications,
  signalAlerts: req.body.signalAlerts,
  marketUpdates: req.body.marketUpdates,
  accountAlerts: req.body.accountAlerts,
  promotionalEmails: req.body.promotionalEmails,
};
```

## المرحلة الخامسة: تحديث وظائف الاستعلام واستيراد/تصدير البيانات

### 1. تعديل استعلامات قاعدة البيانات:

- **الملفات المتأثرة**:
  - `server/db.ts`
  - `server/models/*.ts`
  - وغيرها من ملفات تتعامل مع قاعدة البيانات

- **التغييرات المطلوبة**:
  - التأكد من استخدام أسماء الأعمدة الصحيحة في استعلامات SQL
  - تحديث أي وظائف تحويل البيانات

### 2. تحديث وظائف الاستيراد/التصدير:

- **الملفات المتأثرة**:
  - ملفات تصدير/استيراد البيانات
  - وظائف النسخ الاحتياطي واستعادة البيانات

- **التغييرات المطلوبة**:
  - ضمان تطابق أسماء الحقول في عمليات الاستيراد/التصدير
  - تحديث أي توثيق متعلق بهيكل البيانات

## المرحلة السادسة: الاختبار والتأكد من التوافق

### 1. اختبار جميع وظائف النماذج:

- إنشاء مجموعة اختبارات لضمان عمل جميع النماذج بشكل صحيح
- اختبار عمليات حفظ وجلب وتحديث الإعدادات
- التأكد من عدم وجود أخطاء عند تفاعل المستخدم مع النماذج

### 2. فحص السجلات والتتبع:

- مراقبة السجلات للتأكد من عدم وجود أخطاء متعلقة بأسماء الحقول
- فحص طلبات واستجابات API للتأكد من تطابق أسماء الحقول

## الملفات المتأثرة (قائمة شاملة)

1. **ملفات نماذج البيانات**:
   - `shared/schema.ts`
   - `client/src/types/*.ts`
   - أي ملفات أخرى تحدد أنواع البيانات

2. **ملفات مكونات الواجهة**:
   - `client/src/pages/settings-page.tsx`
   - `client/src/components/settings/*.tsx`
   - وغيرها من المكونات التي تتعامل مع النماذج

3. **ملفات الخادم**:
   - `server/routes.ts`
   - `server/routes/*.ts`
   - وغيرها من ملفات الخادم التي تتعامل مع الطلبات

4. **ملفات المساعدة**:
   - `server/utils/field-mapper.ts`
   - أي ملفات مساعدة أخرى للتحويل

## سجل التنفيذ والخطوات المتبقية

### ما تم إنجازه:

✅ **المرحلة الأولى: تحديد النماذج والحقول**
- تم تحديد النماذج المتأثرة في التطبيق
- تم تحديد الاختلافات بين أسماء الحقول في واجهة المستخدم وقاعدة البيانات

✅ **المرحلة الثانية: تعديل نماذج البيانات في الواجهة**
- تم تعديل واجهة `NotificationSettings` لتتطابق مع أعمدة قاعدة البيانات
- تم تحديث القيم الافتراضية في متغير الحالة `notificationSettings`

✅ **المرحلة الثالثة: تعديل مكونات واجهة المستخدم**
- تم تعديل جميع مكونات التبديل لاستخدام الأسماء الجديدة
- تم إضافة مكون تبديل للإشعارات الترويجية لتغطية جميع الحقول
- تم تحسين معالج التغييرات لتوفير تتبع أفضل للتغييرات

✅ **المرحلة الرابعة: تعديل طلبات API والمعالجات**
- تم تبسيط معالجة طلبات PUT و PATCH في الخادم
- تم استخدام عامل التشغيل `??` للحفاظ على توافق الإصدارات القديمة
- تم تحسين رسائل السجل للتتبع

### الخطوات المتبقية:

✅ **المرحلة الخامسة: تحديث وظائف الاستعلام**
- تم إزالة وظائف تحويل الحقول بين snake_case و camelCase
- تم تحديث ملف `storage.ts` لاستخدام البيانات مباشرة بدون تحويل
- تم حذف ملف `field-mapper.ts` نهائيًا

⬜ **المرحلة السادسة: الاختبار والتحقق**
- اختبار كامل للتطبيق للتأكد من عمل جميع الوظائف
- فحص السجلات للتأكد من خلوها من الأخطاء
- مراقبة الطلبات والاستجابات للتحقق من تطابق أسماء الحقول

## ملاحظات إضافية

- يجب الحفاظ على نسخة احتياطية من البيانات قبل بدء التغييرات
- يفضل إجراء التغييرات على مراحل مع اختبار كل مرحلة قبل الانتقال للمرحلة التالية
- قد تكون هناك حاجة لتحديث الوثائق وملفات المساعدة للمطورين ليعكسوا التغييرات الجديدة

## الخاتمة

تنفيذ هذه الخطة سيؤدي إلى:
- تحسين اتساق الكود وسهولة صيانته
- تقليل احتمالية الأخطاء المتعلقة بأسماء الحقول
- تبسيط الشيفرة وإزالة التحويلات غير الضرورية
- تحسين الأداء العام للتطبيق