import { Router } from 'express';
import fs from 'fs';
import path from 'path';
import { exec } from 'child_process';
import { config } from 'dotenv';

// ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
config();

const router = Router();

// Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª
router.post('/send-command', async (req, res) => {
  try {
    const { command, chatId } = req.body;
    
    if (!command || !chatId) {
      return res.status(400).json({ success: false, message: 'ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± ÙˆÙ…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©' });
    }
    
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª
    
    return res.json({ success: true, message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø±:', error);
    return res.status(500).json({ success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø±' });
  }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬ÙˆÙ… ØªÙ„Ø¬Ø±Ø§Ù…
router.post('/payment-webhook', async (req, res) => {
  try {
    const paymentData = req.body;
    
    console.log('[Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ØªÙ„Ø¬Ø±Ø§Ù…] Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨:', JSON.stringify(paymentData));
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    if (paymentData.message) {
      console.log('[Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ØªÙ„Ø¬Ø±Ø§Ù…] ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…');
      
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      const { message } = paymentData;
      const chatId = message.chat.id;
      const userId = message.from.id;
      const messageText = message.text || 'Ø¨Ø¯ÙˆÙ† Ù†Øµ';
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      console.log(`[Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ØªÙ„Ø¬Ø±Ø§Ù…] Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId}: ${messageText}`);
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      let response = `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒ: "${messageText}"\nØ´ÙƒØ±Ù‹Ø§ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹ BinarJoin Analytics.`;
      
      if (messageText.startsWith('/start')) {
        response = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª BinarJoin Analytics! ğŸ‘‹\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©:\n`
          + `/plans - Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ\n`
          + `/weekly - Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\n`
          + `/monthly - Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©\n`
          + `/annual - Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©\n`
          + `/premium - Ø´Ø±Ø§Ø¡ Ø®Ø·Ø© BinarJoin V.4.1`;
      } else if (messageText.startsWith('/plans')) {
        response = `ğŸ“‹ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n`
          + `ğŸ”¸ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© - 750 Ù†Ø¬Ù…Ø©\n`
          + `ğŸ”¸ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© - 2300 Ù†Ø¬Ù…Ø©\n`
          + `ğŸ”¸ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© - 10000 Ù†Ø¬Ù…Ø©\n`
          + `ğŸ”¸ Ø®Ø·Ø© BinarJoin V.4.1 - 18500 Ù†Ø¬Ù…Ø©\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø£ÙŠ Ø®Ø·Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨:\n`
          + `/weekly, /monthly, /annual, /premium`;
      } else if (messageText.startsWith('/weekly')) {
        response = `â­ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© - 750 Ù†Ø¬Ù…Ø©\n\n`
          + `ØªØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©:\n`
          + `âœ… ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø³ÙˆÙ‚\n`
          + `âœ… Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n`
          + `âœ… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³Ø¹Ø±\n`
          + `âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø³ÙŠØªÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ….`;
      } else if (messageText.startsWith('/monthly')) {
        response = `â­ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© - 2300 Ù†Ø¬Ù…Ø©\n\n`
          + `ØªØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©:\n`
          + `âœ… ÙƒÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\n`
          + `âœ… ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ù…ØªÙ‚Ø¯Ù…\n`
          + `âœ… Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ© Ø®Ø§ØµØ©\n`
          + `âœ… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©\n`
          + `âœ… Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙ…ÙŠØ²\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø³ÙŠØªÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ….`;
      } else if (messageText.startsWith('/annual')) {
        response = `â­ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© - 10000 Ù†Ø¬Ù…Ø©\n\n`
          + `ØªØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©:\n`
          + `âœ… ÙƒÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©\n`
          + `âœ… ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ\n`
          + `âœ… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…Ø®ØµØµØ©\n`
          + `âœ… Ø¥Ø´Ø§Ø±Ø§Øª Ø­ØµØ±ÙŠØ©\n`
          + `âœ… Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©\n`
          + `âœ… Ø¬Ù„Ø³Ø§Øª Ø§Ø³ØªØ´Ø§Ø±ÙŠØ© Ø´Ù‡Ø±ÙŠØ©\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø³ÙŠØªÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ….`;
      } else if (messageText.startsWith('/premium')) {
        response = `â­ Ø®Ø·Ø© BinarJoin V.4.1 - 18500 Ù†Ø¬Ù…Ø©\n\n`
          + `ØªØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©:\n`
          + `âœ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±\n`
          + `âœ… Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª (95%+)\n`
          + `âœ… ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©\n`
          + `âœ… Ø¥Ø´Ø§Ø±Ø§Øª Ø­ØµØ±ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®Ø·Ø·\n`
          + `âœ… Ø¯Ø¹Ù… VIP Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©\n`
          + `âœ… Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø®Ø§ØµØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\n`
          + `âœ… ÙˆØµÙˆÙ„ Ø­ØµØ±ÙŠ Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©\n\n`
          + `Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø³ÙŠØªÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ….`;
      }
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ¹Ù„ÙŠØŒ Ù‡Ù†Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… API ØªÙ„Ø¬Ø±Ø§Ù… Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
      const sendResult = true;
      console.log(`[Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ØªÙ„Ø¬Ø±Ø§Ù…] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­: ${sendResult}`);
      
      return res.json({ success: true, response });
    }
    
    else if (paymentData.payment) {
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹
      const { payment } = paymentData;
      console.log(`[Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ØªÙ„Ø¬Ø±Ø§Ù…] ØªÙ„Ù‚ÙŠ Ø¯ÙØ¹: ${JSON.stringify(payment)}`);
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      
      return res.json({ success: true, message: 'ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­' });
    }
    
    return res.json({ success: true, message: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«' });
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© webhook:', error);
    return res.status(500).json({ success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«' });
  }
});

// ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù… Ù„Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…
router.post('/start-bot', async (req, res) => {
  try {
    const botPath = path.join(__dirname, '../telegram_stars_bot.py');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
    if (!fs.existsSync(botPath)) {
      return res.status(404).json({ success: false, message: 'Ù…Ù„Ù Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    const process = exec(`python ${botPath}`, (error, stdout, stderr) => {
      if (error) {
        console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: ${error.message}`);
        return;
      }
      if (stderr) {
        console.error(`Ù…Ø®Ø±Ø¬Ø§Øª Ø®Ø·Ø£ Ø§Ù„Ø¨ÙˆØª: ${stderr}`);
        return;
      }
      console.log(`Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª: ${stdout}`);
    });
    
    return res.json({ success: true, message: 'ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…:', error);
    return res.status(500).json({ success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…' });
  }
});

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
router.get('/bot-status', (req, res) => {
  // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
  return res.json({ success: true, status: 'running', message: 'Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­' });
});

export default router;